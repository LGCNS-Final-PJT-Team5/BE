apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Chart.Name }}-config
  labels:
    app: {{ .Chart.Name }}
    version: {{ .Chart.AppVersion | default "1.0" }}
data:
  application.yml: |
    server:
      port: {{ .Values.config.server.port | default 8000 }}
    spring:
      jwt:
        issuer: {{ .Values.config.spring.jwt.issuer | default "http://localhost" }}
        secret: ${JWT_SECRET}
      application:
        name: {{ .Chart.Name | default "apigateway-service" }}
      cloud:
        gateway:
          routes:
            # auth-service 라우팅
            - id: auth-service
              uri: http://auth-service.auth-service.svc.cluster.local:80
              predicates:
                - Path=/auth/**
                - Method=GET,POST,PATCH,DELETE
              filters:
                - RemoveRequestHeader=Cookie
            # user-service 라우팅
            - id: user-service
              uri: http://user-service.user-service.svc.cluster.local:80
              predicates:
                - Path=/user/**
                - Method=GET,POST,PATCH,DELETE
              filters:
                - RemoveRequestHeader=Cookie
                - AuthorizationHeaderFilter
            # dashboard-service 라우팅
            - id: dashboard-service
              uri: http://dashboard-service.dashboard-service.svc.cluster.local:80
              predicates:
                - Path=/dashboard/**
                - Method=GET,POST,PATCH,DELETE
              filters:
                - RemoveRequestHeader=Cookie
                - AuthorizationHeaderFilter
            # llm-service 라우팅
            - id: llm-service
              uri: http://llm-service.llm-service.svc.cluster.local:80
              predicates:
                - Path=/llm/**
                - Method=GET,POST,PATCH,DELETE
              filters:
                - RemoveRequestHeader=Cookie
                - AuthorizationHeaderFilter
            # reward-service 라우팅
            - id: reward-service
              uri: http://reward-service.reward-service.svc.cluster.local:80
              predicates:
                - Path=/reward/**
                - Method=GET,POST,PATCH,DELETE
              filters:
                - RemoveRequestHeader=Cookie
                - AuthorizationHeaderFilter
            # admin-service 라우팅
            - id: admin-service
              uri: http://admin-service.admin-service.svc.cluster.local:80
              predicates:
                - Path=/admin/**
                - Method=GET,POST,PATCH,DELETE
              filters:
                - RemoveRequestHeader=Cookie
                - AuthorizationHeaderFilter
            # analysis-service 라우팅
            - id: analysis-service
              uri: http://analysis-service.analysis-service.svc.cluster.local:80
              predicates:
                - Path=/analysis/**
                - Method=GET,POST,PATCH,DELETE
              filters:
                - RemoveRequestHeader=Cookie
                - AuthorizationHeaderFilter
            # agent-service 라우팅
            - id: agent-service
              uri: http://agent-service.agent-service.svc.cluster.local:80
              predicates:
                - Path=/agent/**
                - Method=GET,POST,PATCH,DELETE
              filters:
                - RemoveRequestHeader=Cookie
                - AuthorizationHeaderFilter
    management:
      endpoints:
        web:
          exposure:
            include: "*"
      endpoint:
        gateway:
          enabled: true
        health:
          show-details: always
        prometheus:
          enabled: true
      metrics:
        export:
          prometheus:
            enabled: true